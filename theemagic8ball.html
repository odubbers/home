<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, viewport-fit=cover"
/>
<title>Crystal Task Ball (Mobile-friendly)</title>
<style>
  :root{
    --bg:#000; --purple:#6b3ea8; --pink:#ff66cc; --accent:#b38cff;
    --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
  }

  /* Fill the screen reliably on iOS/Safari */
  html, body {
    height: 100dvh;               /* modern */
    height: 100svh;               /* iOS 16+ fallback */
    height: -webkit-fill-available; /* older iOS fallback */
  }
  html, body { overflow: hidden; }
  body{
    margin:0; display:grid; place-items:center; background:var(--bg); color:#eee;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    padding-top:var(--safe-top); padding-bottom:var(--safe-bottom);
    -webkit-tap-highlight-color: transparent;
    user-select:none;
  }

  /* --- Crystal ball scene --- */
  .scene{ position:relative; width:min(92vw,460px); aspect-ratio:1/1; }

  .ball{
    position:absolute; inset:0; margin:auto; border-radius:50%;
    background: radial-gradient(circle at 50% 45%, rgba(120,80,200,.65), rgba(25,15,45,.98) 70%);
    box-shadow: 0 0 18px rgba(179,140,255,.28);
    cursor:pointer; outline:none;
    touch-action: manipulation;
  }
  .ball:active{ transform: scale(.995); }

  .centerText{
    position:absolute; inset:0; display:grid; place-items:center; border-radius:50%;
    font-weight:800; letter-spacing:.06em; text-transform:uppercase;
    color:#e9ddff; text-shadow:0 0 8px rgba(180,140,255,.25);
    pointer-events:none;
  }

  /* --- Overlay/modal --- */
  .overlay{
    position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6);
    overscroll-behavior: none; /* stop rubber-band */
  }
  .overlay.show{ display:grid; }

  .modal{
    width:min(92vw,520px);
    max-height: calc(100svh - (var(--safe-top) + var(--safe-bottom) + 32px));
    max-height: calc(100dvh - (var(--safe-top) + var(--safe-bottom) + 32px));
    border-radius:14px; padding:18px;
    background:#140a1e; border:1px solid rgba(180,140,255,.25);
    box-shadow: 0 10px 24px rgba(0,0,0,.6);
    text-align:center; overflow:auto; -webkit-overflow-scrolling: touch;
  }
  .title{ font-size: clamp(18px, 5.2vw, 28px); font-weight:700; color:#e9ddff; margin:0 0 8px; }
  .time{ font-variant-numeric:tabular-nums; font-size: clamp(28px, 12vw, 56px); color:#fff; margin: 6px 0 12px; }
  .task{ font-size: clamp(16px, 4.5vw, 20px); color:#e9ddff; margin: 6px 0 14px; }

  .controls{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
  button{ appearance:none; border:none; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:700; letter-spacing:.02em; }
  .btn-primary{ color:#0a0512; background:linear-gradient(180deg, #d8c7ff, #b38cff); box-shadow:0 4px 14px rgba(179,140,255,.3); }
  .btn-ghost{ color:#d9cfff; background:transparent; border:1px solid rgba(200,180,255,.35); }
  .btn-danger{ color:#fff; background:#a43f3f; }

  .brand{ position:fixed; right:10px; bottom:8px; font-size:12px; color:#6951a1; opacity:.6; }

  /* Full-screen alternating flash layer */
  .flash-layer{ position:fixed; inset:0; display:none; pointer-events:none; }
  .flash-layer.show{ display:block; animation: altFlash 2s steps(1,end) 1; }
  @keyframes altFlash{
    0%{ background:var(--purple); }
    20%{ background:var(--pink); }
    40%{ background:var(--purple); }
    60%{ background:var(--pink); }
    80%{ background:var(--purple); }
    100%{ background:transparent; }
  }

  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce){
    *, *::before, *::after{
      animation-duration:.01ms !important;
      animation-iteration-count:1 !important;
      transition-duration:.01ms !important;
      scroll-behavior:auto !important;
    }
  }
</style>
</head>
<body>
  <div class="scene" aria-live="polite">
    <div class="ball" id="ball" role="button" aria-label="Crystal ball. Tap to receive a task." tabindex="0">
      <div class="centerText" id="centerText">Touch Me</div>
    </div>
  </div>

  <!-- Overlay / Modal -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" id="modal">
      <h1 class="title" id="modalTitle">You're dared to...</h1>
      <div class="task" id="taskText">â€¦</div>
      <div class="time" id="time">00:00</div>
      <div class="controls" id="controls">
        <button class="btn-primary" id="beginBtn">Begin</button>
        <button class="btn-ghost" id="skipBtn">Skip (2 left)</button>
        <button class="btn-ghost" id="giveUpBtn">Give Up</button>
      </div>
    </div>
  </div>

  <!-- Full-screen flash layer for timer end -->
  <div class="flash-layer" id="flashLayer"></div>

  <div class="brand">Crystal Task Ball</div>

  <!-- TIP: if /chime.mp3 404s on iPhone, put it next to this file and use "chime.mp3" -->
  <audio id="chime" src="chime.mp3" preload="auto"></audio>

<script>
(() => {
  // ====== CONFIG: tasks with fixed durations ======
  const TASKS = [
    { label: "Massage, upper body only. Him on Her", seconds: 60 }, // <-- missing comma fixed
    { label: "Kiss neck and immediate area Him on Her", seconds: 30 },
    { label: "Kiss neck and immediate area Her on Him", seconds: 30 },
    { label: "Blowjob", seconds: 60 },
    { label: "Go down on her", seconds: 60 },
    { label: "Make Out & Hands Only", seconds: 60 },
    { label: "Doggie Style", seconds: 90 },
    { label: "Her legs up, him standing", seconds: 120 },
    { label: "His choice", seconds: 90 },
    { label: "Her choice", seconds: 90 },

    // --- Added PG-13 intimacy tasks (non-graphic) ---
    { label: "sixty nine 69", seconds: 90 },
    { label: "she rides him", seconds: 90 },
    { label: "slow blow for him ", seconds: 45 },
    { label: "go down on her - slow", seconds: 45 },
    { label: "hands only", seconds: 30 },
    { label: "hard missionary", seconds: 15 },
    { label: "hard doggie", seconds: 15 },
    { label: "sensual missionary", seconds: 45 },
    { label: "spooning", seconds: 60 },
    { label: "hard blowjob", seconds: 20 },
    { label: "go down on her, fast hard", seconds: 20 },
    { label: "her hands locked above head", seconds: 45 },
    { label: "her pillow over eyes", seconds: 45 },
  ];

  // ====== Elements ======
  const ball = document.getElementById('ball');
  const overlay = document.getElementById('overlay');
  const modalTitle = document.getElementById('modalTitle');
  const taskText = document.getElementById('taskText');
  const timeText = document.getElementById('time');
  const beginBtn = document.getElementById('beginBtn');
  const giveUpBtn = document.getElementById('giveUpBtn');
  const skipBtn = document.getElementById('skipBtn');
  const chime = document.getElementById('chime');
  const flashLayer = document.getElementById('flashLayer');

  // ====== State ======
  let currentTask = null;
  let timerId = null;
  let remaining = 0;
  let skipLeft = 2;
  let timerRunning = false;
  let audioUnlocked = false;

  // ====== Helpers ======
  const pad = (n) => String(n).padStart(2, '0');
  const fmt = (sec) => {
    const s = Math.max(0, Math.floor(sec));
    return `${pad(Math.floor(s/60))}:${pad(s%60)}`;
  };
  const updateSkipLabel = () => {
    skipBtn.textContent = `Skip (${skipLeft} left)`;
    if (skipLeft <= 0){ skipBtn.disabled = true; skipBtn.classList.add('btn-danger'); }
    else { skipBtn.disabled = false; skipBtn.classList.remove('btn-danger'); }
  };

  function pickTask(){ return TASKS[Math.floor(Math.random() * TASKS.length)]; }

  function showTask(task){
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    modalTitle.textContent = "You're dared to...";
    taskText.textContent = `${task.label.toLowerCase()}.`;
    timeText.textContent = fmt(task.seconds);
    beginBtn.style.display = '';
    skipBtn.style.display = '';
    giveUpBtn.style.display = '';
    updateSkipLabel();
  }

  function showTimer(){
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    modalTitle.textContent = 'Timer';
    beginBtn.style.display = 'none';
    skipBtn.style.display = 'none';
    giveUpBtn.style.display = '';
  }

  function clearTimer(){
    if (timerId){ clearInterval(timerId); timerId = null; }
    timerRunning = false;
  }

  function stopChime(){ try{ chime.pause(); chime.currentTime = 0; } catch(e){} }

  async function playChimeOnce(){
    try { stopChime(); await chime.play(); } catch(e){ /* Safari may block if not unlocked */ }
  }

  function flashPurplePink(cb){
    flashLayer.classList.add('show');
    const done = () => {
      flashLayer.classList.remove('show');
      flashLayer.removeEventListener('animationend', done);
      cb && cb();
    };
    flashLayer.addEventListener('animationend', done);
  }

  function startCountdown(seconds){
    if (timerRunning) return;
    timerRunning = true;
    remaining = seconds;
    let last = Date.now();

    timerId = setInterval(() => {
      const now = Date.now();
      const dt = Math.min(200, now - last);
      last = now;
      remaining -= dt/1000;

      if (remaining <= 0){
        timeText.textContent = '00:00';
        clearTimer();
        playChimeOnce();
        flashPurplePink(goHome);
        return;
      }

      timeText.textContent = fmt(remaining);
    }, 125);
  }

  function hideOverlay(){
    clearTimer();
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
  }

  function goHome(){
    clearTimer();
    stopChime();
    currentTask = null;
    hideOverlay();
  }

  // --- iOS/Safari: unlock audio on first user gesture ---
  function unlockAudioOnce(){
    if (audioUnlocked) return;
    audioUnlocked = true;
    // Try play->pause to satisfy the gesture requirement
    chime.play().then(() => { chime.pause(); chime.currentTime = 0; }).catch(()=>{});
    // Some iOS versions want an AudioContext resume, too
    try {
      const AC = window.AudioContext || window.webkitAudioContext;
      if (AC) { const ctx = new AC(); ctx.resume().catch(()=>{}); }
    } catch(_){}
  }
  window.addEventListener('touchend', unlockAudioOnce, { once:true, passive:true });
  window.addEventListener('click', unlockAudioOnce, { once:true });

  // ====== Interactions ======
  function requestTask(){
    if (timerRunning) return;
    currentTask = pickTask();
    showTask(currentTask);
  }

  ball.addEventListener('click', requestTask);
  ball.addEventListener('keydown', (e)=>{
    if (e.key==='Enter' || e.key===' '){ e.preventDefault(); requestTask(); }
  });

  beginBtn.addEventListener('click', ()=>{
    if (!currentTask) return;
    showTimer();
    startCountdown(currentTask.seconds);
  });

  skipBtn.addEventListener('click', ()=>{
    if (timerRunning || skipLeft <= 0) return;
    skipLeft--; updateSkipLabel();
    currentTask = pickTask();
    showTask(currentTask);
  });

  // Give Up returns to home instantly (no flash)
  giveUpBtn.addEventListener('click', goHome);

  // Click outside modal to close (only when timer not running)
  overlay.addEventListener('click', (e)=>{ if (e.target === overlay && !timerRunning) goHome(); });
})();
</script>
</body>
</html>
